---
import type { GetStaticPathsOptions, Page } from 'astro';
import { type CollectionEntry, getCollection } from 'astro:content';

import Pagination from '#components/Pagination.astro';
import PostPreview from '#components/PostPreview.astro';
import Subscribe from '#components/Subscribe.astro';
import siteConfig from '#site.config';
import BaseLayout from '#layouts/Layout.astro';
import { getAllTags, getPostsByTag, byDateDesc } from '#lib/utils';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
	const posts = (await getCollection('blog')).sort(byDateDesc);
	const tags = getAllTags(posts);

	return tags.flatMap((tag) => {
		const filteredPosts = getPostsByTag(posts, tag.id);
		return paginate(filteredPosts, {
			params: { id: tag.id },
			pageSize: siteConfig.postsPerPage || 4
		});
	});
}

type Props = { page: Page<CollectionEntry<'blog'>> };

const { page } = Astro.props;
const blog = page.data;
const params = Astro.params;
const allPosts = await getCollection('blog');
const allTags = getAllTags(allPosts);
const currentTag = allTags.find((tag) => {
	return tag.id === params.id;
});
---

<BaseLayout title={`Posts Tagged ${currentTag?.name}`} description={`Explore a curated collection of blog posts under ${currentTag?.name}`}>
	<h1 id="page-title">Posts Tagged "{currentTag?.name}"</h1>
	{blog.map((post) => <PostPreview post={post} />)}
	<Pagination page={page} />
	<Subscribe />
</BaseLayout>

<style is:global>
	@reference '#styles/global.css';

	h1#page-title {
		@apply mb-12 font-serif text-2xl leading-tight;

		@variant sm {
			@apply mb-16 text-4xl;
		}
	}
</style>
